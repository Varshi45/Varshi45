name: Latest blog post workflow
on:
  schedule:
    - cron: '30 0 * * 0' # Weekly on Sunday at 12:30 AM UTC
  workflow_dispatch:
permissions:
  contents: write

jobs:
  update-readme-with-blog:
    name: Update this repo's README with latest blog posts
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y jq curl

      - name: Fetch Medium Blogs
        run: |
          MEDIUM_USERNAME=21pa1a0593
          BLOGS=$(curl -s "https://api.rss2json.com/v1/api.json?rss_url=https://medium.com/feed/@${MEDIUM_USERNAME}" | jq -r '.items | map({title, link}) | .[] | " - [\(.title)](\(.link))"')
          echo "$BLOGS" > blogs.md
          echo "blogs=$BLOGS" >> $GITHUB_ENV

      - name: Debug blogs.md
        run: |
          echo "Debugging blogs.md content:"
          cat blogs.md

      - name: Escape special characters for sed
        run: |
          BLOGS=$(cat blogs.md | sed 's/[&/\]/\\&/g')
          echo "$BLOGS" > escaped_blogs.md

      - name: Update README
        run: |
          BLOGS=$(cat escaped_blogs.md)
          sed -i '/<!-- BLOG-POST-LIST:START -->/,/<!-- BLOG-POST-LIST:END -->/c\<!-- BLOG-POST-LIST:START -->\n'"$BLOGS"'\n<!-- BLOG-POST-LIST:END -->' README.md

      - name: Commit changes
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add README.md
          git commit -m 'Update README with latest Medium blogs'
          git pull --rebase origin main
          git push https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }}.git
